/**
 * @anka-dev/tracker.
 * Tue Aug 07 2018 18:41:52 GMT+0800 (CST)
 * MIT License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Tracker={})}(this,function(t){"use strict";function e(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t){return new Promise(function(e,r){wx.request(u({},t,{success:function(t){t.statusCode>=200&&t.statusCode<300?e&&e(t.data):r&&r(t.data)},fail:function(t){r&&r(t)}}))})}function n(t){return new Promise(function(e,r){wx.setStorage(u({},t,{success:function(t){e(t)},fail:function(t){r(t)}}))})}function o(t){return new Promise(function(e,r){wx.getStorage({key:t,success:function(t){e(t.data)},fail:function(t){r(t)}})})}function i(){return new Promise(function(t,e){wx.getSystemInfo({success:function(e){t(e)},fail:function(t){e(t)}})})}function a(){return new Promise(function(t,e){wx.getNetworkType({success:function(e){t(e.networkType)},fail:function(t){e(t)}})})}function s(t){wx.onNetworkStatusChange(function(e){t(e.networkType)})}const u=Object.assign||function(t){for(var e,r=1;r<arguments.length;r++){e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t};var c,p={DEBUG:!0,log:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.DEBUG&&console.log.apply(console,["[tracker]"].concat(t))}};!function(t){t[t.SUCCESS=-2]="SUCCESS",t[t.PENDING=-1]="PENDING",t[t.FAILED=0]="FAILED"}(c||(c={}));var l,f=function(){function t(t){var e=Date.now();this._id=Math.random().toString(16).replace(".",""),this.status=c.PENDING,this.data=t,this.timestamp=e}return t.prototype.isSucceed=function(){this.status=c.SUCCESS},t.prototype.isFailed=function(){this.status++},t}();!function(t){t[t.IDLE=0]="IDLE",t[t.PAUSE=1]="PAUSE",t[t.RUNNING=2]="RUNNING"}(l||(l={}));var d=function(){function t(t){this.queue=[],this.failedQueue=[],this.config=t,this.lastStoreUpdate=0,this.executor=new h}return t.prototype.init=function(t){var e=this;void 0===this.sender&&(this.sender=t.sender,this.executor.init(this.sender,this)),void 0===this.store&&(this.store=t.store),this.store?this.store.get().then(function(t){var r;(r=e.queue).push.apply(r,t.map(function(t){return new f(t.data)})),e.run()}):this.run()},t.prototype.push=function(t){t.status===c.PENDING&&this.queue.length<this.config.queueMaxLength?(this.queue.push(t),this.updateStore(),this.run()):t.status>=c.FAILED&&t.status<=this.config.retry&&(this.failedQueue.push(t),this.updateStore(),this.run())},t.prototype.pop=function(){var t=this.failedQueue.length,e=this.config.groupMaxLength,r=t-e>=0?this.failedQueue.splice(0,e):this.failedQueue.splice(0,t-1).concat(this.queue.splice(0,e-t));return this.updateStore(),r},t.prototype.updateStore=function(t){var e=Date.now();(this.store&&e-this.lastStoreUpdate>=500||t&&this.store)&&(this.store.update(this.queue.concat(this.failedQueue)),this.lastStoreUpdate=e)},t.prototype.run=function(){this.executor.run()},t.prototype.suspend=function(t){this.updateStore(!0),this.executor.suspend(t)},t}(),h=function(){function t(){this.status=l.IDLE}return Object.defineProperty(t.prototype,"isIdle",{get:function(){return this.sender&&this.queueManager&&this.status===l.IDLE},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.sender=t,this.queueManager=e},t.prototype.run=function(){this.isIdle&&this.exec()},t.prototype.exec=function(){var t=this,e=this.queueManager.pop();if(!e.length)return void(this.status=l.IDLE);this.status=l.RUNNING,Promise.all(e.map(function(e){return t.sender.send(e)})).then(function(e){e.forEach(function(e){e.status!==c.SUCCESS&&t.queueManager.push(e)})}).then(function(){t.timer=setTimeout(function(){t.exec()},t.queueManager.config.interval)})},t.prototype.suspend=function(t){t?(this.status=l.PAUSE,clearTimeout(this.timer)):this.status===l.PAUSE?(this.status=l.IDLE,this.run()):this.status===l.IDLE&&this.run()},t}(),y=function(){function t(t){this.config=t,this.queueManager=new d(this.config)}return t.prototype.init=function(t){this.queueManager.init(u({},t))},t.prototype.log=function(t){this.queueManager.push(t)},t}(),g={debug:!0,retry:2,interval:1e3,groupMaxLength:5,timestampKey:"timestamp_ms",queueMaxLength:500},m=function(){function t(t){void 0===t&&(t={}),t=Object.assign(g,t),this.debug=t.debug,this.trackerHost=t.trackerHost,this.retry=t.retry,this.interval=t.interval,this.groupMaxLength=t.groupMaxLength,this.timestampKey=t.timestampKey,this.queueMaxLength=t.queueMaxLength}return t}(),v=function(){function t(t){this.data=[],this.config=t}return t.prototype.get=function(){return o("tracker_tasks").then(function(t){return Promise.resolve(t)}).catch(function(t){return Promise.resolve([])})},t.prototype.update=function(t){return this.data=t,n({key:"tracker_tasks",data:t})},t}(),b=Object.prototype.hasOwnProperty,w=function(){for(var t=[],e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t}(),_=function(t){for(var e;t.length;){var r=t.pop();if(e=r.obj[r.prop],Array.isArray(e)){for(var n=[],o=0;o<e.length;++o)void 0!==e[o]&&n.push(e[o]);r.obj[r.prop]=n}}return e},k=function(t,e){for(var r=e&&e.plainObjects?Object.create(null):{},n=0;n<t.length;++n)void 0!==t[n]&&(r[n]=t[n]);return r},O={arrayToObject:k,assign:function(t,e){return Object.keys(e).reduce(function(t,r){return t[r]=e[r],t},t)},compact:function(t){for(var e=[{obj:{o:t},prop:"o"}],r=[],n=0;n<e.length;++n)for(var o=e[n],i=o.obj[o.prop],a=Object.keys(i),s=0;s<a.length;++s){var u=a[s],c=i[u];"object"==typeof c&&null!==c&&-1===r.indexOf(c)&&(e.push({obj:i,prop:u}),r.push(c))}return _(e)},decode:function(t){try{return decodeURIComponent(t.replace(/\+/g," "))}catch(e){return t}},encode:function(t){if(0===t.length)return t;for(var e="string"==typeof t?t:String(t),r="",n=0;n<e.length;++n){var o=e.charCodeAt(n);45===o||46===o||95===o||126===o||o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122?r+=e.charAt(n):o<128?r+=w[o]:o<2048?r+=w[192|o>>6]+w[128|63&o]:o<55296||o>=57344?r+=w[224|o>>12]+w[128|o>>6&63]+w[128|63&o]:(n+=1,o=65536+((1023&o)<<10|1023&e.charCodeAt(n)),r+=w[240|o>>18]+w[128|o>>12&63]+w[128|o>>6&63]+w[128|63&o])}return r},isBuffer:function(t){return null!==t&&void 0!==t&&!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))},isRegExp:function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},merge:function t(e,r,n){if(!r)return e;if("object"!=typeof r){if(Array.isArray(e))e.push(r);else{if("object"!=typeof e)return[e,r];(n.plainObjects||n.allowPrototypes||!b.call(Object.prototype,r))&&(e[r]=!0)}return e}if("object"!=typeof e)return[e].concat(r);var o=e;return Array.isArray(e)&&!Array.isArray(r)&&(o=k(e,n)),Array.isArray(e)&&Array.isArray(r)?(r.forEach(function(r,o){b.call(e,o)?e[o]&&"object"==typeof e[o]?e[o]=t(e[o],r,n):e.push(r):e[o]=r}),e):Object.keys(r).reduce(function(e,o){var i=r[o];return b.call(e,o)?e[o]=t(e[o],i,n):e[o]=i,e},o)}},j=String.prototype.replace,S={default:"RFC3986",formatters:{RFC1738:function(t){return j.call(t,/%20/g,"+")},RFC3986:function(t){return t}},RFC1738:"RFC1738",RFC3986:"RFC3986"},D={brackets:function(t){return t+"[]"},indices:function(t,e){return t+"["+e+"]"},repeat:function(t){return t}},P=Date.prototype.toISOString,x={delimiter:"&",encode:!0,encoder:O.encode,encodeValuesOnly:!1,serializeDate:function(t){return P.call(t)},skipNulls:!1,strictNullHandling:!1},N=function t(e,r,n,o,i,a,s,u,c,p,l,f){var d=e;if("function"==typeof s)d=s(r,d);else if(d instanceof Date)d=p(d);else if(null===d){if(o)return a&&!f?a(r,x.encoder):r;d=""}if("string"==typeof d||"number"==typeof d||"boolean"==typeof d||O.isBuffer(d))return a?[l(f?r:a(r,x.encoder))+"="+l(a(d,x.encoder))]:[l(r)+"="+l(String(d))];var h=[];if(void 0===d)return h;var y;if(Array.isArray(s))y=s;else{var g=Object.keys(d);y=u?g.sort(u):g}for(var m=0;m<y.length;++m){var v=y[m];i&&null===d[v]||(h=Array.isArray(d)?h.concat(t(d[v],n(r,v),n,o,i,a,s,u,c,p,l,f)):h.concat(t(d[v],r+(c?"."+v:"["+v+"]"),n,o,i,a,s,u,c,p,l,f)))}return h},E=function(t,e){var r=t,n=e?O.assign({},e):{};if(null!==n.encoder&&void 0!==n.encoder&&"function"!=typeof n.encoder)throw new TypeError("Encoder has to be a function.");var o=void 0===n.delimiter?x.delimiter:n.delimiter,i="boolean"==typeof n.strictNullHandling?n.strictNullHandling:x.strictNullHandling,a="boolean"==typeof n.skipNulls?n.skipNulls:x.skipNulls,s="boolean"==typeof n.encode?n.encode:x.encode,u="function"==typeof n.encoder?n.encoder:x.encoder,c="function"==typeof n.sort?n.sort:null,p=void 0!==n.allowDots&&n.allowDots,l="function"==typeof n.serializeDate?n.serializeDate:x.serializeDate,f="boolean"==typeof n.encodeValuesOnly?n.encodeValuesOnly:x.encodeValuesOnly;if(void 0===n.format)n.format=S.default;else if(!Object.prototype.hasOwnProperty.call(S.formatters,n.format))throw new TypeError("Unknown format option provided.");var d,h,y=S.formatters[n.format];"function"==typeof n.filter?r=(h=n.filter)("",r):Array.isArray(n.filter)&&(d=h=n.filter);var g=[];if("object"!=typeof r||null===r)return"";var m;m=n.arrayFormat in D?n.arrayFormat:"indices"in n?n.indices?"indices":"repeat":"indices";var v=D[m];d||(d=Object.keys(r)),c&&d.sort(c);for(var b=0;b<d.length;++b){var w=d[b];a&&null===r[w]||(g=g.concat(N(r[w],w,v,i,a,s?u:null,h,c,p,l,y,f)))}var _=g.join(o),k=!0===n.addQueryPrefix?"?":"";return _.length>0?k+_:""},A=Object.prototype.hasOwnProperty,I={allowDots:!1,allowPrototypes:!1,arrayLimit:20,decoder:O.decode,delimiter:"&",depth:5,parameterLimit:1e3,plainObjects:!1,strictNullHandling:!1},C=function(t,e){for(var r={},n=e.ignoreQueryPrefix?t.replace(/^\?/,""):t,o=e.parameterLimit===1/0?void 0:e.parameterLimit,i=n.split(e.delimiter,o),a=0;a<i.length;++a){var s,u,c=i[a],p=c.indexOf("]="),l=-1===p?c.indexOf("="):p+1;-1===l?(s=e.decoder(c,I.decoder),u=e.strictNullHandling?null:""):(s=e.decoder(c.slice(0,l),I.decoder),u=e.decoder(c.slice(l+1),I.decoder)),A.call(r,s)?r[s]=[].concat(r[s]).concat(u):r[s]=u}return r},L=function(t,e,r){for(var n=e,o=t.length-1;o>=0;--o){var i,a=t[o];if("[]"===a)i=(i=[]).concat(n);else{i=r.plainObjects?Object.create(null):{};var s="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,u=parseInt(s,10);!isNaN(u)&&a!==s&&String(u)===s&&u>=0&&r.parseArrays&&u<=r.arrayLimit?(i=[])[u]=n:i[s]=n}n=i}return n},q=function(t,e,r){if(t){var n=r.allowDots?t.replace(/\.([^.[]+)/g,"[$1]"):t,o=/(\[[^[\]]*])/g,i=/(\[[^[\]]*])/.exec(n),a=i?n.slice(0,i.index):n,s=[];if(a){if(!r.plainObjects&&A.call(Object.prototype,a)&&!r.allowPrototypes)return;s.push(a)}for(var u=0;null!==(i=o.exec(n))&&u<r.depth;){if(u+=1,!r.plainObjects&&A.call(Object.prototype,i[1].slice(1,-1))&&!r.allowPrototypes)return;s.push(i[1])}return i&&s.push("["+n.slice(i.index)+"]"),L(s,e,r)}},M={formats:S,parse:function(t,e){var r=e?O.assign({},e):{};if(null!==r.decoder&&void 0!==r.decoder&&"function"!=typeof r.decoder)throw new TypeError("Decoder has to be a function.");if(r.ignoreQueryPrefix=!0===r.ignoreQueryPrefix,r.delimiter="string"==typeof r.delimiter||O.isRegExp(r.delimiter)?r.delimiter:I.delimiter,r.depth="number"==typeof r.depth?r.depth:I.depth,r.arrayLimit="number"==typeof r.arrayLimit?r.arrayLimit:I.arrayLimit,r.parseArrays=!1!==r.parseArrays,r.decoder="function"==typeof r.decoder?r.decoder:I.decoder,r.allowDots="boolean"==typeof r.allowDots?r.allowDots:I.allowDots,r.plainObjects="boolean"==typeof r.plainObjects?r.plainObjects:I.plainObjects,r.allowPrototypes="boolean"==typeof r.allowPrototypes?r.allowPrototypes:I.allowPrototypes,r.parameterLimit="number"==typeof r.parameterLimit?r.parameterLimit:I.parameterLimit,r.strictNullHandling="boolean"==typeof r.strictNullHandling?r.strictNullHandling:I.strictNullHandling,""===t||null===t||void 0===t)return r.plainObjects?Object.create(null):{};for(var n="string"==typeof t?C(t,r):t,o=r.plainObjects?Object.create(null):{},i=Object.keys(n),a=0;a<i.length;++a){var s=i[a],u=q(s,n[s],r);o=O.merge(o,u,r)}return O.compact(o)},stringify:E},U=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.getCommonData=function(t){var e=t.onLaunchOption;return Promise.all([this.getTrackId(),i(),a()]).then(function(t){var r=t[0],n=t[1],o=t[2],i=n.system.split(/\s+/),a=M.stringify(e.query),s={__debug:1,sdk_version:"0.0.1",model:n.model,os:i[0],os_version:i[1],network_type:o,env_version:n.version,ip:"",app_type:"wx",app_id:"",app_name:"",template_version:"",app_category:"",source:e.scene,source_path:e.path,source_app_id:e.referrerInfo?e.referrerInfo.appId:"",source_params:a,source_src_key:e.query?e.query.src:"",track_id:r};return Promise.resolve(s)})},r.prototype.getTrackId=function(){var t=this;return o(r.TRACK_ID_KEY).then(function(t){return Promise.resolve(t)}).catch(function(e){return t.setTrackId()})},r.prototype.setTrackId=function(){var t=this.genUUId();return n({key:r.TRACK_ID_KEY,data:t}).then(function(){return Promise.resolve(t)},function(){return n({key:r.TRACK_ID_KEY,data:t}),Promise.resolve(t)})},r.prototype.genUUId=function(){return Date.now()+"-"+Math.floor(1e7*Math.random())+"-"+Math.random().toString(16).replace(".","")+"-"+String(31242*Math.random()).replace(".","").slice(0,8)},r.prototype.validate=function(t){var e={required:[],optional:[]},n=r.dataScheme;for(var o in n)n.hasOwnProperty(o)&&!t[o]&&e[1===n[o]?"required":"optional"].push(o);return e},r}(function(){function t(){}return t.validate=function(t){var e={required:[],optional:[]},r=this.dataScheme;for(var n in r)r.hasOwnProperty(n)&&!t[n]&&e[1===r[n]?"required":"optional"].push(n);return e},t.TRACK_ID_KEY="bx_track_id",t.dataScheme={event_type:1,tracktype:1,action:1,timestamp_ms:1,__debug:0,app_type:1,app_id:1,app_name:1,template_version:1,app_category:1,preview_version:0,app_role:0,internal_app:0,track_id:1,open_id:0,union_id:0,bx_user_id:0,visitor_mobile:0,distinct_id:0,ip:1,os:1,os_version:1,model:1,network_type:1,env_version:0,source:1,source_path:1,source_params:0,source_src_key:0,source_app_id:0,page_type:1,page_id:1,last_page_type:0,last_page_id:0,page_level:1,sdk_version:1},t}()),T=function(){function t(t,e){this.url=t.trackerHost,this.config=t,this.commonData=e}return t.prototype.send=function(t){var e=u({},this.commonData,t.data);return p.log("打点数据校验结果:",t,U.validate(e)),r({url:this.url,method:"POST",data:e}).then(function(){return t.isSucceed(),Promise.resolve(t)}).catch(function(){return t.isFailed(),Promise.resolve(t)})},t}(),R=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.getNetworkStatus=function(){return a().then(function(t){return Promise.resolve(t)},function(t){return console.error("[tracker] 获取网络状态失败",t),Promise.resolve("none")})},r.prototype.watchNetworkStatusChange=function(t){s(t)},r}(function(){function t(){}return t}()),F=function(){function t(t){void 0===t&&(t={}),this.config=new m(t),this.core=new y(this.config),p.DEBUG=this.config.debug,this.core.queueManager.suspend(!0),this.networkDetector=new R,this.commonDataVendor=new U}return t.prototype.init=function(t){var e=this.handleNetworkStatusChange.bind(this);this.sender=new T(this.config,t),this.store=new v(this.config),this.core.init({sender:this.sender,store:this.store}),this.networkDetector.getNetworkStatus().then(e,e),this.networkDetector.watchNetworkStatusChange(e)},t.prototype.handleNetworkStatusChange=function(t){var e="none"===t||t instanceof Error;this.core.queueManager.suspend(e)},t.prototype.log=function(t){var e=Date.now();t[this.config.timestampKey]=e,this.core.log(new f(t))},t.prototype.commonData=function(t){return this.commonDataVendor.getCommonData(t)},t}(),H={};try{H=require("./anka-tracker.config.js")}catch(t){}var K=new F(H);t.tracker=K,t.Tracker=F,Object.defineProperty(t,"__esModule",{value:!0})});
